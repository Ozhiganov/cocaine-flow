{% if grouped_manifests %}
    <div class="well well-small">
    <h3>Manifests
        <small>({{ grouped_manifests|length }})</small>
    </h3>
    </div>
    <table class="table table-bordered">
        {% for app_name, common_manifest_dict in grouped_manifests.items() %}
            <tr>
                <td>
                    <div>
                        <a data-target="#versions_{{ app_name|replace(" ","_")}}" data-toggle='collapse'>
                           <strong> {{ app_name}} </strong>
                        </a>
                        <small>({{ common_manifest_dict['manifests']|length }})</small>
                        - {{ common_manifest_dict['description'] }} -
                        <em>{{ common_manifest_dict['type'] }}</em>
                    </div>
                    <div id="versions_{{ app_name|replace(" ","_")}}" class="collapse">
                        {% for manifest in common_manifest_dict['manifests'] %}

                            <dl>
                                <hr>

                                <dt>
                                    <h4> {{ manifest.uuid }}

                                    {% if user.admin %}
                                        <span class="pull-right">
                                            <button type="button" class="btn btn-mini deploy"
                                                    data-uuid="{{ manifest.uuid }}">
                                                Deploy
                                            </button>

                                        <button type="button" class="btn btn-danger btn-mini remove"
                                                data-id="{{ manifest.uuid }}">Remove
                                        </button>
                                    </span>
                                    {% endif %}
                                    </h4>

                                </dt>
                                <dd>

                                    {% if manifest.url %}
                                        <dl>
                                            <dt>Cloned from</dt>
                                            <dd> <a href="{{ manifest.git_to_html_url }}"> {{ manifest.url }} </a></dd>
                                        </dl>
                                    {% endif %}

                                    <dl>
                                        <dt>Developer</dt>
                                        <dd>{{ manifest.developer_username }}</dd>
                                    </dl>

                                    {% if manifest.depends %}
                                        <dl>
                                            <dt>Dependencies</dt>
                                            {% for depends in manifest.depends %}
                                                <dd>{{ depends }}</dd>
                                            {% endfor %}
                                        </dl>
                                    {% endif %}

                                    {% if manifest.drivers %}
                                        <dl>
                                            <dt>Drivers</dt>
                                            {% for alias, settings in manifest.drivers.items() %}
                                                <dd>
                                                          {{ alias }}
                                                    <pre>{{ settings|pprint }}</pre>
                                                </dd>
                                            {% endfor %}
                                        </dl>
                                    {% endif %}


                                    {% if manifest.args %}
                                        <dl>
                                            <dt>Args</dt>
                                            <dd>{{ manifest.args|pprint }}</dd>
                                        </dl>
                                    {% endif %}

                                    {% if manifest.changelog %}

                                        <dl>
                                            <dt>Changelog</dt>
                                            {% for change in manifest.changelog %}
                                                {% set change_info = change.split() %}
                                                <dd>
                                                <div class="span2">{{ change_info[0] }}</div>
                                                <div class="span2">{{ change_info[1] }}</div>
                                                <div class="span8">{{ change_info[2:]|join(" ") }}</div>
                                                </dd>
                                            {% endfor %}
                                        </dl>
                                    {% endif %}

                                    {% if manifest.structure %}
                                        {# <dl>
                                            <dt>Structure</dt>
                                            {% for record in manifest.structure %}
                                                <dd>{{ record }}</dd>
                                            {% endfor %}
                                        </dl>
                                    #}
                                    <div class="accordion-heading" >
                                        <a class="accordion-toggle" data-toggle="collapse" href="#Structure_{{manifest.uuid|replace(" ","_")}}"><h5>Structure</h5></a>
                                    </div>
                                    <div id="Structure_{{manifest.uuid|replace(" ","_")}}" class="accordion-body collapse">
                                        <div class="accordion-inner">
                                            <dl>
                                            {% for record in manifest.structure %}
                                                <dd> {{record}}</dd>
                                            {% endfor %}
                                            </dl>
                                        </div>
                                    </div>

                                    {% endif %}


                                </dd>
                            </dl>
                        {% endfor %}

                    </div>
                </td>
            </tr>
        {% endfor %}
    </table>
{% else %}
    <h3>No manifests</h3>
{% endif %}

{% if runlists %}
    <div class="well well-small">
    <h3>Runlists
        <small>({{ runlists|length }})</small>
        <a href="#myModal" role="button" class="pull-right btn btn-success" data-toggle="modal">Runlist manager</a>
    </h3>
    </div>
    <table class="table table-bordered runlists">
        <thead>
        <tr>
            <th>Name</th>
            <th>Apps-Profiles</th>
        </tr>
        </thead>

        {% for runlist_name, runlist in runlists.items() %}
            <tr>
                <td>{{ runlist_name }}</td>
                <td>
                    {% for app_name, profile_name in runlist.items() %}
                        <div class="clearfix runlist">
                                <span class="pull-left">
                                    {{ app_name }} - <span class="edit select">{{ profile_name }}</span>
                                </span>
                            <button type="button" class="pull-right undeploy btn btn-danger btn-mini"
                               data-url="{{ runlist_name }}/{{ app_name }}/{{ profile_name }}">Undeploy</button>
                        </div>
                    {% endfor %}
                </td>
            </tr>
        {% endfor %}
    </table>
{% else %}
    <h3>No runlists</h3>
{% endif %}

{% if profiles %}
    <div class="well well-small">
    <h3>Profiles
        <small>({{ profiles|length }})</small>
        <a href="#ModalAddProfile" role="button" class="pull-right btn btn-success" data-toggle="modal">Profile manager</a>
    </h3>
    </div>
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>Name</th>
            <th>Config</th>
        </tr>
        </thead>

        {% for profile_name, profile in profiles.items() %}
            <tr>
                <td>{{ profile_name }}</td>
                <td>
                    <ul class="unstyled">
                        {% for option, value in profile|dictsort %}
                            <li>
                                {{ option }} - <span class="edit text-info"
                                                     id="profile:{{ profile_name }}:{{ option }}:{{ value }}">{{ value }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                </td>
            </tr>
        {% endfor %}
    </table>
{% else %}
    <h3>No profiles</h3>
{% endif %}

{% if hosts %}
        <div class="well well-small">
                <h3 >Hosts
                        <a href="#ModalAddHost" role="button" class="pull-right btn btn-success" data-toggle="modal">Host manager</a>
                </h3>
        </div>
{#
    <table class="table table-bordered table-hover">
    {% for alias, hosts in hosts.items() %}
            <tr class="info"><td > <h4 class="text-success">{{ alias }}</h4> </td></tr>
                <tbody>
                    {% for host in hosts %}
                    <tr><td>

                    <div class="host-info" data-hostname="{{host}}">
                    <strong> {{ host }} </strong>
                                            <button type="button" class="pull-right remove_host btn btn-danger btn-mini"
                                                    data-host="{{alias}}:{{host}}">
                                                    Remove
                                            </button>
                    </div>

                    </td></tr>
                    {% endfor %}
                </tbody>
    {% endfor %}
    </table>
#}
<!-- TEST -->
<div >
{% for alias, hosts in hosts.items() %}
    <div class="accordion-group">
        <div class="AAAA " my-target="hosts_{{alias}}">
                                  <h4> &nbsp Cluster {{ alias }}
                                    <button type="button" class="pull-right remove_alias btn btn-danger btn-mini"
                                                    data-alias="{{alias}}">
                                                    Remove cluster
                                    </button></h4>
        </div>
    </div>
        <div id="hosts_{{ alias }}" class="collapse">
                    <div class="tabbabel tabs-left">
                        <ul class="nav nav-tabs">
                            {% for host in hosts %}
                                {% if loop.first%}
                                    <li class="active"><a href="#{{alias}}{{loop.index0}}_tab" data-toggle="tab"><h4>{{host}}</h4></a></li>
                                {% else %}
                                    <li ><a href="#{{alias}}{{loop.index0}}_tab" data-toggle="tab"><h4>{{host}}</h4></a></li>
                                {% endif %}
                            {% endfor %}
                            </ul>
                        <div class="tab-content">
                            {% for host in hosts %}
                                {% if loop.first%}
                                    <div class="tab-pane active" id="{{alias}}{{loop.index0}}_tab">
                                {% else %}
                                    <div class="tab-pane" id="{{alias}}{{loop.index0}}_tab">
                                {% endif %}
                                    <h4>Some information about {{host}} bla-bla
                                            <button type="button" class="pull-right remove_host btn btn-danger btn-mini"
                                                    data-host="{{alias}}:{{host}}">
                                                    Remove
                                            </button>
                                    </h4>
                                   </div>
                            {% endfor %}
                        </div>
                    </div>
        </div>
{% endfor %}
</div>
<!-- ENDTEST -->
{% else %}
<div class="well well-small">
    <h3>No hosts</h3>
</div>
{% endif %}

<!-- Modal window for add host -->

<div id="ModalAddHost" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Enter hostname and press "Add host"</h3>
</div>
<form class="form-search">
<p>&nbsp</p>
    <div class="span2"> 
        <label class="control-label" for="url">
            <p class="text-success"><h4>Cluster</h4></p>
            <p class="text-success"><h4>Hostname</h4></p>
        </label>
    </div>
    <div class="control-group">
        <div class="controls">
            <input type="text" name="url" placeholder="mycluster" id="alias_name_for_add" class="input alias_name_for_add">
            <input type="text" name="url" placeholder="example.host.net" id="host_name_for_add" class="input host_name_for_add">
        </div>
    </div>
</form>
<div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary add_host">Add host</button>
</div>
</div>
<!-- END -->
<!-- Modal window for add profile -->
<div id="ModalAddProfile" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Enter hostname and press "Add host"</h3>
</div>
<form class="form-search">
<p>&nbsp</p>
    <div class="span2"> 
        <label class="control-label" for="url">
            <p class="text-success"><h4>Hostname</h4></p>
        </label>
    </div>
    <div class="control-group">
        <div class="controls">
            <input type="text" name="url" placeholder="mycluster" id="alias_name_for_add" class="input alias_name_for_add">
        </div>
    </div>
</form>
<div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary add_host">Add host</button>
</div>
</div>
<!-- END -->

{% if user.admin %}
    {% block js %}
        <script type="text/javascript" src="{{ url_for('static', filename='bootbox.min.js') }}"></script>

        <script type="text/javascript">
            $(document).ready(function ()
                              {
                                  $('.AAAA').click(
                                    function()
                                    {
                                        var target = $(this).attr('my-target');
                                        $('#'+target).collapse('toggle');
                                    }
                                  );
                                  $('.remove').click(
                                          function ()
                                          {
                                              var app_id = $(this).attr('data-id');
                                              var btn = $(this);
                                              bootbox.confirm("Are you sure?", "No", "Yes", function (result)
                                              {
                                                  if (result)
                                                  {
                                                      $.ajax({
                                                                 url:'/app/' + app_id,
                                                                 type:"DELETE",
                                                                 success:function (data, textStatus, jqXHR)
                                                                 {
                                                                     btn.parents('dl').remove();
                                                                 }
                                                             });
                                                  }
                                              });
                                          });

                                  function create_select(entities, title)
                                  {
                                      var s = "<div class='control-group'>" +
                                                "<label class='control-label'>" + title +
                                                ":</label>" +
                                                "<div class='controls'>" +
                                                    "<select class='span2' name='" + title + "'>" +
                                                "</div>" +
                                              "</div>";
                                      for (var index in entities)
                                      {
                                          s += "<option value='" + entities[index] + "'>" + entities[index] + "</option>";
                                      }
                                      s += "</select>";
                                      console.log(s);
                                      return s;
                                  }

                                  $('.remove_host').click(
                                          function ()
                                          {
                                              var alias_host = $(this).attr('data-host').split(':');
                                              bootbox.confirm("Do u really want to remove?", "No", "Yes", function (result)
                                              {
                                                  if (result)
                                                  {
                                                            $.ajax({
                                                                    url:'/hosts/'+ alias_host[0] + '/' + alias_host[1],
                                                                    type:"DELETE",
                                                                    success:function (data, textStatus, jqXHR)
                                                                    {
                                                                        bootbox.alert("Host:" + alias_host + "is removed succesfully!", function(){
                                                                            location.reload(true);
                                                                        });
                                                                    },
                                                                    error:function (jqXHR, textStatus, errorThrown)
                                                                    {
                                                                        bootbox.alert(jqXHR.responseText, function(){
                                                                        location.reload(true);
                                                                    });
                                                                    }       
                                                                });
                                                  }
                                              });

                                          }
                                  );

                                  $('.remove_alias').click(
                                          function ()
                                          {
                                              var alias = $(this).attr('data-alias');
                                              bootbox.confirm("Do u really want to remove?", "No", "Yes", function (result)
                                              {
                                                  if (result)
                                                  {
                                                            $.ajax({
                                                                    url:'/hosts/'+ alias,
                                                                    type:"DELETE",
                                                                    success:function (data, textStatus, jqXHR)
                                                                    {
                                                                        bootbox.alert("Cluster " + alias + "is removed succesfully!", function(){
                                                                            location.reload(true);
                                                                        });
                                                                    },
                                                                    error:function (jqXHR, textStatus, errorThrown)
                                                                    {
                                                                        bootbox.alert(jqXHR.responseText, function(){
                                                                        location.reload(true);
                                                                    });
                                                                    }       
                                                                });
                                                  }
                                              });

                                          }
                                  );

                                  $('.add_host').click(
                                            function ()
                                            {
                                                var hostname = $('.host_name_for_add').val();
                                                var alias = $('.alias_name_for_add').val();
                                                
                                                $.ajax({
                                                            url:'/hosts/'+ alias + '/' + hostname,
                                                            type:"POST",
                                                            success:function (data, textStatus, jqXHR)
                                                            {
                                                                bootbox.alert("Host is added succesfully!", function(){
                                                                location.reload(true);
                                                                });
                                                            },
                                                            error:function (jqXHR, textStatus, errorThrown)
                                                            {
                                                                bootbox.alert(jqXHR.responseText, function(){
                                                                        location.reload(true);
                                                                });
                                                            }
                                            });
                                    }
                                  );

                                  $('.deploy').click(
                                          function ()
                                          {
                                              var uuid = $(this).attr('data-uuid');
                                              var btn = $(this);
                                              var str = $("<span>Loading...</span>");
                                              $.getJSON('/runlists', function (runlists)
                                              {
                                                  $.getJSON('/profiles', function (profiles)
                                                  {
                                                      str.html(create_select(runlists, "Runlist") + create_select(profiles, "Profile"));
                                                  });
                                              });

                                              bootbox.confirm(str, "No", "Yes", function (result)
                                              {
                                                  if (result)
                                                  {
                                                      var runlist = $("select[name=Runlist]", str).val();
                                                      var profile = $("select[name=Profile]", str).val();
                                                      console.log(runlist);
                                                      console.log(profile);
                                                      $.ajax({
                                                                 url:'/deploy/' + runlist + '/' + uuid + '/' + profile,
                                                                 type:"POST",
                                                                 success:function (data, textStatus, jqXHR)
                                                                 {
                                                                     bootbox.alert("Application is deployed");
                                                                 },
                                                                 error:function (jqXHR, textStatus, errorThrown)
                                                                 {
                                                                     bootbox.alert(jqXHR.responseText, function(){
                                                                         location.reload(true);
                                                                     });
                                                                 }
                                                             });

                                                  }
                                              });
                                          });


                                  $('.undeploy').click(
                                          function ()
                                          {
                                              var url = $(this).attr('data-url');
                                              var btn = $(this);
                                              bootbox.confirm("Are you sure?", "No", "Yes", function (result)
                                              {
                                                  if (result)
                                                  {
                                                      $.ajax({
                                                                 url:'/undeploy/' + url,
                                                                 type:"POST",
                                                                 success:function (data, textStatus, jqXHR)
                                                                 {
                                                                     btn.parents('div.runlist').remove();
                                                                     bootbox.alert("Application is undeployed");
                                                                 },
                                                                 error:function (jqXHR, textStatus, errorThrown)
                                                                 {
                                                                     bootbox.alert(jqXHR.responseText, function(){
                                                                         location.reload(true);
                                                                     });
                                                                 }
                                                             });

                                                  }
                                              });
                                          });


                                  $('.edit.text-info').editable('/dashboard/edit', {
                                      style:'display: inline',
                                      tooltip:'Click to edit...'
                                  });

                                  $('.edit.select').editable('/dashboard/edit', {
                                      style:'display: inline',
                                      loadurl:'/profiles',
                                      type:'select',
                                      cssclass:'form-horizontal',
                                      loaddata:{view:'dict'},
                                      callback:function (value, settings)
                                      {
                                          console.log(this);
                                          console.log(value);
                                          console.log(settings);
                                      }
                                  });


                              });


        </script>
    {% endblock %}
{% endif %}
